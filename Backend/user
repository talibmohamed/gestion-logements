<?php
class residant
{
    public $res_ID;
    public $log_ID;
    public $nom;
    public $prenom;
    public $cin;
    public $mot_de_passe;
    public $email;
    public $telephone;
    public $profession;
    public $date_ajout;

    private $db;

    public function __construct(Database $db)
    {
        $this->db = $db;
        $this->db->connect();
        $this->db->getConnection();
    }

    // API endpoint function to handle user login
    public function loginUser($email, $password)
    {
        try {
            // Get the established connection
            $connection = $this->db->getConnection();
            $sql = $connection->prepare('SELECT password FROM residant WHERE email = ?');
            $sql->execute([$email]);
            $user = $sql->fetch(PDO::FETCH_ASSOC);

            if ($user) {
                // we gonna unhased the password from the db cuz the database store the password hashed
                if ($password == $user['password']) { //compare the unhashed pass with the password we get from the request
                    // Generate JWT token
                    $jwtHandler = new JwtHandler();
                    $admin = false;
                    $jwt_token = $jwtHandler->generateJwtToken($user, $admin);

                    // Return success response with JWT token
                    return array('status' => 'success', 'jwt_token' => $jwt_token);
                } else {
                    // Return error response if password is incorrect
                    return array('status' => 'error', 'message' => 'Invalid password');
                }
            } else {
                // Return error response if user does not exist
                return array('status' => 'error', 'message' => 'User not found');
            }
        } catch (PDOException $e) {
            // Return error response if an exception occurs
            return array('status' => 'error', 'message' => $e->getMessage());
        }
    }
    //changement de mot de passe
    public function changePassword($currentPassword, $newPassword ,$res_ID)
    {
        $connection = $this->db->getConnection();
        // Vérifier le mot de passe actuel
        if (!$this->checkCurrentPassword($currentPassword,$res_ID)) {
            throw new Exception("Le mot de passe actuel est incorrect.");
        }

        // Hacher le nouveau mot de passe
        $hashedPassword = password_hash($newPassword, PASSWORD_BCRYPT);

        // Mettre à jour le mot de passe dans la base de données
        $sql = "UPDATE residant SET password = :newPassword WHERE res_id = :res_ID";
        $stmt = $connection->prepare($sql);
        $stmt->bindParam(':newPassword', $hashedPassword);
        $stmt->bindParam(':userId', $this->$res_ID);

        if ($stmt->execute()) {
            return true;
        } else {
            throw new Exception("Erreur lors de la mise à jour du mot de passe.");
        }
    }
    public function checkCurrentPassword($currentPassword, $res_ID) {
        // Get the database connection
        $connection = $this->db->getConnection();
    
        // Prepare the SQL query to select the password for the given res_ID
        $sql = "SELECT password FROM residant WHERE res_id = :userId";
        $stmt = $connection->prepare($sql);
    
        // Bind the 'res_ID' parameter to the SQL query
        $stmt->bindParam(':userId', $res_ID, PDO::PARAM_INT);
    
        // Execute the query
        $stmt->execute();
    
        // Fetch the user data
        $user = $stmt->fetch(PDO::FETCH_ASSOC);
    
        // Verify the current password against the stored hash
        if ($user && password_verify($currentPassword, $user['password'])) {
            return true;
        } else {
            return false;
        }
    }
    
    // Méthode pour mettre à jour les informations personnelles
    public function updatePersonalInfo($email, $telephone, $res_ID)
    {
        $connection = $this->db->getConnection();

        $sql = "UPDATE residant SET email = :email, telephone = :telephone WHERE res_id = :res_ID";
        $stmt = $connection->prepare($sql);
        $stmt->bindParam(':email', $email);
        $stmt->bindParam(':telephone', $telephone);
        $stmt->bindParam(':res_id', $this->$res_ID);

        if ($stmt->execute()) {
            return true;
        } else {
            throw new Exception("Erreur lors de la mise à jour des informations personnelles.");
        }
    }
    public function statistic_eau($res_ID) {
        $connection = $this->db->getConnection();
    
        // Prepare and execute the quota query
        $quotaStmt = $connection->prepare("SELECT cons_quota FROM consommation WHERE res_id = :res_ID AND cons_type = 'water'");
        $quotaStmt->bindParam(':res_ID', $res_ID, PDO::PARAM_INT);
        $quotaStmt->execute();
        $quota = $quotaStmt->fetchColumn();
    
        // Prepare and execute the actuel query
        $actuelStmt = $connection->prepare("SELECT cons_actuel FROM consommation WHERE res_id = :res_ID AND cons_type = 'water'");
        $actuelStmt->bindParam(':res_ID', $res_ID, PDO::PARAM_INT);
        $actuelStmt->execute();
        $actuel = $actuelStmt->fetchColumn();
    
        // Check if quota is not zero to avoid division by zero
        if ($quota > 0) {
            // Return the percentage
            return ($actuel / $quota) * 100;
        } else {
            // Handle the case when quota is zero
            return 0;
        }
    }
    public function statistic_electricity($res_ID) {
        $connection = $this->db->getConnection();
    
        // Prepare and execute the quota query
        $quotaStmt = $connection->prepare("SELECT cons_quota FROM consommation WHERE res_id = :res_ID AND cons_type = 'Electricity'");
        $quotaStmt->bindParam(':res_ID', $res_ID, PDO::PARAM_INT);
        $quotaStmt->execute();
        $quota = $quotaStmt->fetchColumn();
    
        // Prepare and execute the actuel query
        $actuelStmt = $connection->prepare("SELECT cons_actuel FROM consommation WHERE res_id = :res_ID AND cons_type = 'Electricity'");
        $actuelStmt->bindParam(':res_ID', $res_ID, PDO::PARAM_INT);
        $actuelStmt->execute();
        $actuel = $actuelStmt->fetchColumn();
    
        // Check if quota is not zero to avoid division by zero
        if ($quota > 0) {
            // Return the percentage
            return ($actuel / $quota) * 100;
        } else {
            // Handle the case when quota is zero
            return 0;
        }
    }
    public function affiche_factures($res_ID) {
        // Get the database connection
        $connection = $this->db->getConnection();
    
        // Prepare the SQL query to select all records from 'facture' where 'res_id' matches the provided parameter
        $fac = $connection->prepare("SELECT * FROM facture WHERE res_id = :res_ID ORDER BY fac_date DESC");
    
        // Bind the 'res_ID' parameter to the SQL query
        $fac->bindParam(':res_ID', $res_ID, PDO::PARAM_INT);
    
        // Execute the query
        $fac->execute();
    
        // Fetch all results
        $results = $fac->fetchAll(PDO::FETCH_ASSOC);
    
        // Return the fetched results
        return $results;
    }
    public function historique_reclamations($res_ID) {
        // Get the database connection
        $connection = $this->db->getConnection();
         $rec = $connection->prepare("SELECT * FROM reclamation where res_id = :res_ID ORDER BY rec_date DESC");
         // Bind the 'res_ID' parameter to the SQL query
        $rec->bindParam(':res_ID', $res_ID, PDO::PARAM_INT);
        // Execute the query
        $rec->execute();
    
        // Fetch all results
        $results = $rec->fetchAll(PDO::FETCH_ASSOC);
    
        // Return the fetched results
        return $results;
    }
    

    

}
